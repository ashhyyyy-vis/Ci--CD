name: Deploy (Mock AWS)

on:
  workflow_run:
    workflows: ["Stack-Agnostic CI"]
    types: [completed]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      apps-json: ${{ steps.read.outputs.apps }}
      app-ids: ${{ steps.app-ids.outputs.ids }}
      apps-b64: ${{ steps.app-ids.outputs.apps_b64 }}

    steps:
      - uses: actions/checkout@v4

      - name: Read deployment-config.json
        id: read
        shell: bash
        run: |
          if [ ! -f deployment-config.json ]; then
            echo "ERROR: deployment-config.json not found"
            exit 1
          fi

          # READ ONLY BACKEND
          APPS=$(jq -c '.backend' deployment-config.json)
          echo "apps=$APPS" >> $GITHUB_OUTPUT

      - name: Extract backend app IDs
        id: app-ids
        shell: bash
        run: |
          RAW='${{ steps.read.outputs.apps }}'

          RAW_B64=$(printf "%s" "$RAW" | base64 -w0)
          echo "apps_b64=$RAW_B64" >> $GITHUB_OUTPUT

          IDS=$(echo "$RAW" | jq -c 'keys')
          echo "ids=$IDS" >> $GITHUB_OUTPUT

  deploy:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app-id: ${{ fromJson(needs.prepare.outputs.app-ids) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Parse backend app config
        id: parse
        shell: bash
        run: |
          APP_KEY="${{ matrix.app-id }}"
          APP_KEY=$(echo "$APP_KEY" | sed 's/"//g')

          APPS_JSON=$(echo "${{ needs.prepare.outputs.apps-b64 }}" | base64 -d)

          APP_JSON=$(printf "%s" "$APPS_JSON" | jq -c --arg k "$APP_KEY" '.[$k]')

          echo "$APP_JSON" | jq '.'

          echo "image_repo=$(echo "$APP_JSON" | jq -r '.image_repo')" >> $GITHUB_OUTPUT
          echo "launch_template_id=$(echo "$APP_JSON" | jq -r '.launch_template_id')" >> $GITHUB_OUTPUT
          echo "asg_name=$(echo "$APP_JSON" | jq -r '.asg_name')" >> $GITHUB_OUTPUT
          echo "region=$(echo "$APP_JSON" | jq -r '.region')" >> $GITHUB_OUTPUT
          echo "port=$(echo "$APP_JSON" | jq -r '.port')" >> $GITHUB_OUTPUT
          echo "health_path=$(echo "$APP_JSON" | jq -r '.health_path')" >> $GITHUB_OUTPUT
          echo "instance_warmup=$(echo "$APP_JSON" | jq -r '.instance_warmup')" >> $GITHUB_OUTPUT
          echo "min_healthy_percent=$(echo "$APP_JSON" | jq -r '.min_healthy_percent')" >> $GITHUB_OUTPUT
          echo "user_data_template=$(echo "$APP_JSON" | jq -r '.user_data_template')" >> $GITHUB_OUTPUT
          echo "ssm_param_name=$(echo "$APP_JSON" | jq -r '.ssm_param_name')" >> $GITHUB_OUTPUT

      - name: Mock AWS Credentials
        run: |
          echo "=== MOCK CREDS ==="
          echo "Region: ${{ steps.parse.outputs.region }}"

      - name: Export deployment vars
        id: vars
        run: |
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "image_repo=${{ steps.parse.outputs.image_repo }}" >> $GITHUB_OUTPUT
          echo "lt_id=${{ steps.parse.outputs.launch_template_id }}" >> $GITHUB_OUTPUT
          echo "asg_name=${{ steps.parse.outputs.asg_name }}" >> $GITHUB_OUTPUT
          echo "ud_template=${{ steps.parse.outputs.user_data_template }}" >> $GITHUB_OUTPUT
          echo "ssm_param=${{ steps.parse.outputs.ssm_param_name }}" >> $GITHUB_OUTPUT
          echo "warmup=${{ steps.parse.outputs.instance_warmup }}" >> $GITHUB_OUTPUT
          echo "minheal=${{ steps.parse.outputs.min_healthy_percent }}" >> $GITHUB_OUTPUT

      - name: Mock SSM Update
        if: ${{ steps.vars.outputs.ud_template == 'ssm' }}
        run: |
          echo "MOCK SSM update â†’ ${{ steps.vars.outputs.ssm_param }}"

      - name: Mock Launch Template Update
        if: ${{ steps.vars.outputs.ud_template != 'ssm' }}
        id: newlt
        run: |
          echo "Mock LT update"
          echo "new_version=42" >> $GITHUB_OUTPUT

      - name: Mock ASG Update
        run: |
          echo "Mock ASG update"

      - name: Mock Instance Refresh
        id: refresh
        run: |
          echo "refresh_id=mock-123" >> $GITHUB_OUTPUT

      - name: Mock Refresh Status
        run: |
          echo "Mock refresh: Successful"
